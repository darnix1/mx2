#!/usr/bin/env python3
import os
import sys
import subprocess
from datetime import datetime, timedelta
from rich.console import Console
from rich.table import Table
from rich.panel import Panel
from rich.layout import Layout
from rich.text import Text
from rich.box import ROUNDED
from rich.align import Align  # Esto es lo que faltaba importar

# Configurar consola Rich
console = Console()

# Estilos
STYLE_TITLE = "bold bright_white on dark_blue"
STYLE_HEADER = "bold bright_white"
STYLE_OPTION = "bright_yellow"
STYLE_VALUE = "bright_white"
STYLE_ON = "bright_green"
STYLE_OFF = "bright_red"

def clear_screen():
    """Limpia la pantalla de la terminal"""
    os.system('clear' if os.name == 'posix' else 'cls')

def run_cmd(cmd):
    """Ejecuta un comando de shell y devuelve el resultado"""
    try:
        return subprocess.run(
            cmd, 
            shell=True, 
            check=True, 
            stdout=subprocess.PIPE, 
            stderr=subprocess.PIPE,
            text=True
        ).stdout.strip()
    except subprocess.CalledProcessError:
        return ""

def get_system_info():
    """Obtiene información del sistema"""
    info = {}
    
    # Información básica
    info['os'] = run_cmd("cat /etc/os-release | grep PRETTY_NAME | cut -d'=' -f2 | tr -d '\"'")
    info['domain'] = run_cmd("cat /etc/xray/domain 2>/dev/null") or "No configurado"
    info['ip'] = run_cmd("curl -s ifconfig.me") or "No disponible"
    
    # Memoria RAM
    mem = run_cmd("free -m | awk 'NR==2 {print $2 \" \" $3}'").split()
    info['ram_total'] = f"{int(mem[0])}MB" if len(mem) > 0 else "0MB"
    info['ram_used'] = f"{int(mem[1])}MB" if len(mem) > 1 else "0MB"
    
    # Ubicación
    info['isp'] = run_cmd("cat /etc/xray/isp 2>/dev/null") or "Desconocido"
    info['city'] = run_cmd("cat /etc/xray/city 2>/dev/null") or "Desconocida"
    info['author'] = run_cmd("cat /etc/profil 2>/dev/null") or "Desconocido"
    
    # Estado de servicios
    def is_service_active(service):
        return run_cmd(f"systemctl is-active {service}") == "active"
    
    info['ssh_status'] = "ON" if is_service_active("ws-stunnel") else "OFF"
    info['xray_status'] = "ON" if is_service_active("xray") else "OFF"
    info['nginx_status'] = "ON" if is_service_active("nginx") else "OFF"
    
    # Conteo de usuarios
    def count_users(pattern, file):
        try:
            if os.path.exists(file):
                with open(file, 'r') as f:
                    return sum(1 for line in f if line.startswith(pattern))
            return 0
        except:
            return 0
    
    info['ssh_users'] = count_users("### ", "/etc/xray/ssh")
    info['vmess_users'] = count_users("#vmg ", "/etc/xray/config.json")
    info['vless_users'] = count_users("#vlg ", "/etc/xray/config.json")
    info['trojan_users'] = count_users("#trg ", "/etc/xray/config.json")
    
    return info

def create_menu_layout(info):
    """Crea el diseño del menú principal"""
    layout = Layout()
    
    # 1. Encabezado
    header = Panel(
        Text(" MENÚ PRINCIPAL ", justify="center"), 
        style=STYLE_TITLE,
        box=ROUNDED
    )
    
    # 2. Información del sistema
    sys_info = Table.grid(padding=(0, 2))
    sys_info.add_column(style=STYLE_OPTION, width=15)
    sys_info.add_column(style=STYLE_VALUE)
    
    sys_info.add_row("Sistema Operativo", info['os'])
    sys_info.add_row("Dominio", info['domain'])
    sys_info.add_row("IP Pública", info['ip'])
    sys_info.add_row("RAM", f"{info['ram_used']} / {info['ram_total']}")
    sys_info.add_row("Ubicación", f"{info['city']} ({info['isp']})")
    sys_info.add_row("Autor", info['author'])
    
    sys_panel = Panel(
        sys_info,
        title="[bold]INFORMACIÓN DEL SISTEMA[/]",
        border_style="blue",
        box=ROUNDED
    )
    
    # 3. Estado de servicios
    services = Table.grid(padding=(0, 2))
    services.add_row(
        f"SSHWS: [{STYLE_ON if info['ssh_status'] == 'ON' else STYLE_OFF}]{info['ssh_status']}[/]",
        f"XRAY: [{STYLE_ON if info['xray_status'] == 'ON' else STYLE_OFF}]{info['xray_status']}[/]",
        f"NGINX: [{STYLE_ON if info['nginx_status'] == 'ON' else STYLE_OFF}]{info['nginx_status']}[/]"
    )
    
    services_panel = Panel(
        Align.center(services),
        title="[bold]ESTADO DE SERVICIOS[/]",
        border_style="blue",
        box=ROUNDED
    )
    
    # 4. Usuarios registrados
    users = Table(
        show_header=True,
        header_style="bold bright_white",
        box=ROUNDED,
        expand=True
    )
    users.add_column("Servicio", style="bright_white", justify="center")
    users.add_column("Usuarios", style="bright_green", justify="center")
    
    users.add_row("SSH", str(info['ssh_users']))
    users.add_row("VMESS", str(info['vmess_users']))
    users.add_row("VLESS", str(info['vless_users']))
    users.add_row("TROJAN", str(info['trojan_users']))
    
    users_panel = Panel(
        users,
        title="[bold]USUARIOS REGISTRADOS[/]",
        border_style="blue",
        box=ROUNDED
    )
    
    # 5. Opciones del menú
    menu_options = [
        ("1. SSH/OpenVPN", "Administración de usuarios SSH", "7. NotiBot", "Configuración de notificaciones"),
        ("2. Xray/VMESS", "Configuración VMESS", "8. Temas", "Personalizar interfaz"),
        ("3. Xray/VLESS", "Configuración VLESS", "9. Actualizar", "Actualizar scripts"),
        ("4. Trojan", "Configuración Trojan", "10. Sistema", "Configuración del sistema"),
        ("5. Servicios", "Gestión de servicios", "11. Backup", "Copias de seguridad"),
        ("6. Telegram Bot", "Configuración del bot", "12. Reiniciar", "Reiniciar servicios")
    ]
    
    menu_table = Table.grid(padding=(0, 2), expand=True)
    menu_table.add_column(width=15)
    menu_table.add_column(width=30)
    menu_table.add_column(width=15)
    menu_table.add_column(width=30)
    
    for row in menu_options:
        menu_table.add_row(
            f"[{STYLE_OPTION}]{row[0]}[/]",
            row[1],
            f"[{STYLE_OPTION}]{row[2]}[/]",
            row[3]
        )
    
    menu_panel = Panel(
        menu_table,
        title="[bold]OPCIONES DEL MENÚ[/]",
        border_style="blue",
        box=ROUNDED,
        padding=(1, 1)
    )
    
    # Construir layout completo
    layout.split(
        Layout(header, name="header", size=3),
        Layout(sys_panel, name="sys_info"),
        Layout(services_panel, name="services", size=4),
        Layout(users_panel, name="users", size=6),
        Layout(menu_panel, name="menu")
    )
    
    return layout

def main_menu():
    """Muestra el menú principal"""
    clear_screen()
    info = get_system_info()
    layout = create_menu_layout(info)
    
    console.print(layout)
    
    # Input para selección
    console.print("\n")
    try:
        opt = console.input("[bright_white]Seleccione una opción (1-12): [/][bright_green]").strip()
        
        # Mapeo de opciones
        option_actions = {
            '1': "m-sshovpn",
            '01': "m-sshovpn",
            '2': "m-vmess",
            '02': "m-vmess",
            '3': "m-vless",
            '03': "m-vless",
            '4': "m-trojan",
            '04': "m-trojan",
            '5': "running",
            '05': "running",
            '6': "m-bot",
            '06': "m-bot",
            '7': "m-bot2",
            '07': "m-bot2",
            '8': "m-theme",
            '08': "m-theme",
            '9': "m-update",
            '09': "m-update",
            '10': "m-system",
            '11': "m-backup",
            '12': "m-restart"
        }
        
        if opt in option_actions:
            os.system(option_actions[opt])
        else:
            console.print("[bright_red]Opción no válida. Intente nuevamente.[/]")
            time.sleep(1)
            main_menu()
            
    except KeyboardInterrupt:
        console.print("\n[bright_red]Saliendo del menú...[/]")
        sys.exit(0)

if __name__ == "__main__":
    try:
        while True:
            main_menu()
    except Exception as e:
        console.print(f"[bright_red]Error: {str(e)}[/]")
        sys.exit(1)
