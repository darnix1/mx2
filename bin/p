#!/bin/bash

while true; do
    # Obtener lista única de usuarios (emails)
    emails=($(grep -oP '(?<="email": ")[^"]+' /etc/xray/*.json | sort -u))

    # Mostrar menú numerado
    echo -e "══════════════════════════" | lolcat
    echo -e " <= V2RAY USERS LIST =>"
    echo -e "══════════════════════════" | lolcat

    for i in "${!emails[@]}"; do
        printf "%3d) %s\n" $((i+1)) "${emails[$i]}"
    done

    echo -e "══════════════════════════" | lolcat

    # Leer opción
    read -p "Select user number to change UUID: " selection
    user="${emails[$((selection-1))]}"

    # Validación
    if [ -z "$user" ]; then
        echo "Invalid selection. Try again."
        continue
    fi

    # Obtener UUID actual
    current_uuid=$(grep -A 2 "\"email\": \"$user\"" /etc/xray/*.json | grep -oP '(?<="id": ")[^"]+')

    # Limpiar pantalla
    clear
    last_six=${current_uuid: -6}
    echo -e "User selected: $user"
    echo -e "Current UUID ends with: ...${last_six}"
    echo

    # Confirmar si es correcto
    read -p "Is this the correct UUID for the user? (y/n): " confirm
    if [[ "$confirm" =~ ^[Yy]$ ]]; then
        read -p "Enter new UUID: " uuid
        sed -i -E "/\"email\": \"$user\"/,/}/s/\"id\": \"[^\"]+\"/\"id\": \"$uuid\"/" /etc/xray/*.json

        systemctl daemon-reload
        systemctl restart xray

        clear
        echo -e "══════════════════════════" | lolcat
        echo -e " <= SUCCESSFULLY CHANGED UUID =>"
        echo -e "══════════════════════════" | lolcat
        echo -e "USER (EMAIL): $user"
        echo -e "NEW UUID: $uuid"
        echo -e "══════════════════════════" | lolcat
        break
    else
        clear
        echo "Returning to menu..."
        sleep 1
    fi
done
