#!/bin/bash
clear
# Obtener lista única de usuarios (emails)
emails=($(grep -oP '(?<="email": ")[^"]+' /etc/xray/*.json | sort -u))

# Mostrar menú de usuarios numerado

title
amacen " CAMBIAR UUID USUARIOS VMESS"
msg -bar
gris " Cambiar el uuid constantemente"
gris " puede inhabilitar el servicio XRAY"
#gris " Si el el caso favor de buscar el fix xray"
msg -bar
for i in "${!emails[@]}"; do
    printf "%3d) %s\n" $((i+1)) "${emails[$i]}"
done

msg -bar
# Leer opción de usuario
read -p "Seleccione el usuario: " selection
user="${emails[$((selection-1))]}"

# Verifica si la selección es válida
if [ -z "$user" ]; then
    echo "Selección no válida. Saliendo.."
    exit 1
fi

# Leer nuevo UUID (sin mostrar el anterior)
read -p "Nuevo UUID para $user: " uuid

# Cambiar UUID
sed -i -E "/\"email\": \"$user\"/,/}/s/\"id\": \"[^\"]+\"/\"id\": \"$uuid\"/" /etc/xray/*.json

# Reiniciar servicio
systemctl daemon-reload
systemctl restart xray

# Confirmación
clear
title
dnxver " CAMBIO UUID VMESS EXITOSO"
msg -bar
green "USUARIO : $user"
green "NUEVO UUID: $uuid"
msg -bar
